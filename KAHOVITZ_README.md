# 🎭 Kahovitz Story Pipeline v2

A sophisticated AI-powered story generation system that creates consistent, engaging narratives using multiple Groq language models orchestrated through a structured pipeline.

## 🌟 Features

- **Multi-Model Architecture**: Uses 5 separate Groq API keys for optimal performance and rate limit management
- **Phased Story Development**: Structured story progression through setup, rising action, climax, and resolution
- **Character Consistency**: Dedicated models for each character to maintain personality and dialogue consistency
- **Intelligent Summarization**: Periodic story summaries to maintain narrative coherence
- **Adaptive Narration**: AI-powered decision making for when to add narrative bridges
- **Comprehensive Output**: Generates both structured JSON data and readable Markdown stories
- **Web Interface**: User-friendly web UI for story planning and generation

## 🏗️ Architecture

### Model-Role Mapping

| Model | API Key | Purpose | Description |
|-------|---------|---------|-------------|
| **Char1** | `GROQ_1` | Character Dialogue | Generates dialogue for the first character |
| **Char2** | `GROQ_2` | Character Dialogue | Generates dialogue for the second character |
| **A/S/D** | `GROQ_3` | Multi-Purpose | Handles prompt refinement, summarization, and narration |
| **B** | `GROQ_4` | Master Summary | Creates comprehensive story summaries |
| **C** | `GROQ_5` | Classifier | Determines when narration should be added |

### Pipeline Flow

1. **User Input** → Rough story idea
2. **Model A** → Refines prompt and creates phase plan
3. **User Confirmation** → Review and approve plan
4. **Model A** → Generates opening scene
5. **Character Dialogue** → Char1 and Char2 alternate turns
6. **Periodic Summarization** → Model S summarizes every N turns
7. **Narration Decision** → Model C decides if narration is needed
8. **Narration Generation** → Model D creates narrative bridges (if needed)
9. **Master Summary** → Model B creates final comprehensive summary
10. **Output Generation** → JSON and Markdown formats

## 🚀 Quick Start

### Prerequisites

1. **Node.js** (v14 or higher)
2. **Groq API Keys** (5 separate keys)
3. **Environment Variables** configured

### Installation

1. **Install dependencies**:
   ```bash
   npm install
   ```

2. **Configure environment variables** in `.env`:
   ```env
   GROQ_1=your_first_groq_api_key
   GROQ_2=your_second_groq_api_key
   GROQ_3=your_third_groq_api_key
   GROQ_4=your_fourth_groq_api_key
   GROQ_5=your_fifth_groq_api_key
   ```

3. **Test the system**:
   ```bash
   node test-kahovitz.js
   ```

4. **Start the server**:
   ```bash
   node Kahovitz.js
   ```

5. **Visit the web interface**:
   ```
   http://localhost:5175
   ```

## 📡 API Endpoints

### POST `/api/plan`

Generates a story plan from a rough idea.

**Request Body:**
```json
{
  "roughIdea": "A fantasy adventure about a knight and a rogue"
}
```

**Response:**
```json
{
  "refinedPrompt": "Detailed story prompt...",
  "phasePlan": {
    "setup": "Introduction of characters and world",
    "risingAction": "Building tension and conflict",
    "climax": "Peak of the story's conflict",
    "resolution": "Conclusion and character growth"
  },
  "openingScene": "Engaging opening scene..."
}
```

### POST `/api/generate-story`

Generates a complete story based on the approved plan.

**Request Body:**
```json
{
  "refinedPrompt": "Detailed story prompt...",
  "openingScene": "Opening scene...",
  "phasePlan": {
    "setup": "...",
    "risingAction": "...",
    "climax": "...",
    "resolution": "..."
  },
  "totalUtterances": 20,
  "summaryInterval": 4
}
```

**Response:**
```json
{
  "data": {
    "initialContext": "...",
    "openingScene": "...",
    "conversations": [
      {
        "speaker": "Char1",
        "text": "Dialogue...",
        "turn": 1,
        "phase": "setup"
      }
    ],
    "summaries": [
      {
        "turn": 4,
        "summary": "Summary of turns 1-4..."
      }
    ],
    "narrations": [
      {
        "turn": 4,
        "narration": "Narrative bridge..."
      }
    ],
    "masterSummary": "Comprehensive story summary..."
  },
  "markdown": "# Story Generated by Kahovitz..."
}
```

### GET `/health`

Health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "service": "Kahovitz Story Pipeline v2",
  "groqKeys": {
    "char1": true,
    "char2": true,
    "asd": true,
    "b": true,
    "c": true
  }
}
```

## 🎯 Usage Examples

### Web Interface

1. **Visit** `http://localhost:5175`
2. **Enter** your rough story idea
3. **Click** "Generate Plan" to create the story structure
4. **Review** the generated plan and opening scene
5. **Click** "Generate Full Story" to create the complete narrative
6. **Download** the story as Markdown

### Programmatic Usage

```javascript
// Generate a story plan
const planResponse = await fetch('http://localhost:5175/api/plan', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    roughIdea: "A sci-fi story about time travel"
  })
});

const plan = await planResponse.json();

// Generate the full story
const storyResponse = await fetch('http://localhost:5175/api/generate-story', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ...plan,
    totalUtterances: 20,
    summaryInterval: 4
  })
});

const story = await storyResponse.json();
console.log(story.data.masterSummary);
```

## 🔧 Configuration

### Model Configuration

The system uses the following model settings:

```javascript
const MODEL_CONFIG = {
  model: "llama-3.3-70b-versatile",
  temperature: 0.8,
  maxTokens: 500
};
```

### Phase Distribution

Stories are automatically divided into phases:

- **Setup**: First 25% of utterances
- **Rising Action**: 25-50% of utterances
- **Climax**: 50-75% of utterances
- **Resolution**: 75-100% of utterances

### Rate Limiting

- **Character Models**: Separate API keys prevent rate limit conflicts
- **Summarization**: Batched per phase for efficiency
- **Narration**: Only generated when classifier determines it's needed

## 🧪 Testing

Run the comprehensive test suite:

```bash
node test-kahovitz.js
```

This will test:
- ✅ All API key configurations
- ✅ Model A (Prompt refinement & planning)
- ✅ Char1 & Char2 (Character dialogue)
- ✅ Model S (Summarization)
- ✅ Model C (Classifier)
- ✅ Model D (Narration)
- ✅ Model B (Master summary)

## 📁 File Structure

```
├── Kahovitz.js              # Main server and orchestrator
├── test-kahovitz.js         # Comprehensive test suite
├── KAHOVITZ_README.md       # This documentation
├── .env                     # Environment variables (not in repo)
└── package.json             # Dependencies
```

## 🔍 Troubleshooting

### Common Issues

1. **Missing API Keys**
   - Ensure all 5 Groq API keys are set in `.env`
   - Run `node test-kahovitz.js` to verify

2. **Rate Limiting**
   - The system uses separate API keys to avoid conflicts
   - If you hit limits, consider reducing `totalUtterances`

3. **JSON Parsing Errors**
   - Model A responses are automatically sanitized
   - Fallback parsing handles malformed JSON

4. **Classifier Inconsistency**
   - Model C responses are sanitized to ensure True/False output
   - Default behavior is to not add narration on unclear responses

### Debug Mode

Enable detailed logging by setting:

```javascript
// In Kahovitz.js
const DEBUG = true;
```

## 🎨 Customization

### Modifying Character Personalities

Edit the character dialogue prompts in `generateCharacterDialogue()`:

```javascript
const systemPrompt = `You are ${character}, a [specific personality type] in an ongoing story...`;
```

### Adjusting Story Parameters

Modify the default values in the API endpoints:

```javascript
totalUtterances = 20,    // Total dialogue turns
summaryInterval = 4      // Summarize every N turns
```

### Changing Model Configuration

Update `MODEL_CONFIG` for different models or parameters:

```javascript
const MODEL_CONFIG = {
  model: "llama-3.3-70b-versatile",  // Change model
  temperature: 0.8,                   // Adjust creativity
  maxTokens: 500                      // Modify length
};
```

## 📈 Performance Optimization

### Resource Management

- **Caching**: Responses are not cached by default (add if needed)
- **Batching**: Summarization is batched per phase
- **Throttling**: Character turns are processed sequentially

### Scaling Considerations

- **Multiple Instances**: Run multiple Kahovitz instances on different ports
- **Load Balancing**: Use a reverse proxy for multiple instances
- **Database**: Add persistent storage for story history

## 🤝 Contributing

1. **Fork** the repository
2. **Create** a feature branch
3. **Test** your changes with `node test-kahovitz.js`
4. **Submit** a pull request

## 📄 License

This project is part of the Moscownpur creative suite.

## 🆘 Support

For issues and questions:
1. Check the troubleshooting section
2. Run the test suite to verify configuration
3. Review the API documentation
4. Check the health endpoint for system status

---

**🎭 Kahovitz Story Pipeline v2** - Where AI meets storytelling magic! ✨
